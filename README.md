# Счетчик конкурентных запросов

Асинхронный скрипт выполняет 100 запросов на эндпоинт. Эндпойнт на каждый запрос увеличивает счетчик в таблице БД на 1.
В конце работы скрипта счетчик в БД должен быть равен 100.

Реализация: в модели БД реализовано три метода увеличения счетчика. В зависимости от номера метода, передаваемого в эндпойнт,
в таблице создается запись с соответствующим id при ее отсутствии и/или поле count увеличивается на 1.

Методы увеличения счетчика и корректность работы при разных уровнях изолированности транзакций:


| Уровень изолированности\Метод | 1. Путем блокировки таблицы | 2. Путем блокировки строки | 3. На уровне базы данных |
|-------------------------------|-----------------------------|----------------------------|--------------------------|
| `read uncommitted`            | +                           | +                          | +                        |
| `read committed`              | +                           | +                          | +                        |
| `repeatable read`             | +                           | -                          | -                        |
| `serializable`                | +                           | -                          | -                        |

## Используемые технологии
Бэкенд: python3.10, django, gunicorn

API: django rest framework

СУБД: PostgreSQL

Линтеры: isort, flake8

## Настройка проекта

Проект настраивается через переменные окружения, указанные в файле src/.env

Пример .env файла указан в .env.example:

| Ключ                | Значение                                                         | По умолчанию                    |
|---------------------|------------------------------------------------------------------|---------------------------------|
| `SECRET_KEY`        | Секретный ключ. Должен иметь уникальное непредсказуемое значение | `the-most-secret-key`           |
| `DEBUG`             | Режим дебага                                                     | `True`                          |
| `SQL_ENGINE`        | Движок БД                                                        | `django.db.backends.postgresql` |
| `POSTGRES_DB`       | Имя БД                                                           | `counter`                       |
| `POSTGRES_USER`     | Пользователь БД                                                  | `postgres`                      |
| `POSTGRES_PASSWORD` | Пароль пользователя БД                                           | `postgres`                      |
| `POSTGRES_HOST`     | Адрес СУБД                                                       | `db`                            |
| `POSTGRES_PORT`     | Порт СУБД                                                        | `5432`                          |
| `STATIC_PATH`       | Путь до статических файлов                                       | `/project/static`               |
| `APP_PROXY_PORT`    | Порт контейнера с бэкендом                                       | `8000`                          |
| `APP_PROXY_LINK`    | Наименование контейнера с бэкендом                               | `app`                           |

## Запуск проекта:

В корне проекта запустить команду:

`docker-compose -f docker-compose.yml up --build -d`

Доступ по адресу: `127.0.0.1:8000`

Сваггер: `127.0.0.1:8000/api/v1/swagger`

Админ-панель: `127.0.0.1:8000/admin`

Для создания администратора в контейнере "app" необходимо запустить команду:

`python manage.py createsuperuser`

## Тестирование

Тестирование счетчика запросов осуществляется с помощью скрипта `run_requests.py`, расположенного в папке deploy/test.

Для запуска скрипта необходимо:

1) В директории проекта создать виртуальное окружение python3.10:
    `python3.10 -m venv venv`
2) Активировать виртуальное окружение:
   `. venv/bin/activate` для Linux или `.\venv\Scripts\activate` для Windows
3) Установить зависимость для запуска скрипта:
   `pip install aiohttp`
4) Запустить скрипт с параметрами:
   `python ./deploy/test/run_requests.py -d [domain] -n [number]`

где 
`-d [domain]`- хост:порт/домен запросов к API, `-n [number]`- номер метода увеличения счетчика запросов

Скрипт выполняет 100 асинхронных запросов на эндпойнт `counter/[number]`. 
Проверить количество запросов в БД возможно по эндпойнту `/count` в сваггере или по запросу на `127.0.0.1:8000/api/v1/endpoint/count`